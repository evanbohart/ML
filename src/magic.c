#include <stdlib.h>
#include "chess.h"

bitboard get_blockers(bitboard mask, int x)
{
    bitboard blockers = 0ULL;
    int n = __builtin_popcountll(mask);

    for (int i = 0; i < n; ++i) {
        int bit = __builtin_ctzll(mask);
        clear_bit(&mask, bit);

        if (x & (1 << i)) {
            set_bit(&blockers, bit);
        }
    }

    return blockers;
}

bitboard *bishop_attack_table[64];

const bitboard bishop_masks[64] = {
    0x0040201008040200ULL, 0x0000402010080400ULL, 0x0000004020100a00ULL, 0x0000000040221400ULL,
    0x0000000002442800ULL, 0x0000000204085000ULL, 0x0000020408102000ULL, 0x0002040810204000ULL,
    0x0020100804020000ULL, 0x0040201008040000ULL, 0x00004020100a0000ULL, 0x0000004022140000ULL,
    0x0000000244280000ULL, 0x0000020408500000ULL, 0x0002040810200000ULL, 0x0004081020400000ULL,
    0x0010080402000200ULL, 0x0020100804000400ULL, 0x004020100a000a00ULL, 0x0000402214001400ULL,
    0x0000024428002800ULL, 0x0002040850005000ULL, 0x0004081020002000ULL, 0x0008102040004000ULL,
    0x0008040200020400ULL, 0x0010080400040800ULL, 0x0020100a000a1000ULL, 0x0040221400142200ULL,
    0x0002442800284400ULL, 0x0004085000500800ULL, 0x0008102000201000ULL, 0x0010204000402000ULL,
    0x0004020002040800ULL, 0x0008040004081000ULL, 0x00100a000a102000ULL, 0x0022140014224000ULL,
    0x0044280028440200ULL, 0x0008500050080400ULL, 0x0010200020100800ULL, 0x0020400040201000ULL,
    0x0002000204081000ULL, 0x0004000408102000ULL, 0x000a000a10204000ULL, 0x0014001422400000ULL,
    0x0028002844020000ULL, 0x0050005008040200ULL, 0x0020002010080400ULL, 0x0040004020100800ULL,
    0x0000020408102000ULL, 0x0000040810204000ULL, 0x00000a1020400000ULL, 0x0000142240000000ULL,
    0x0000284402000000ULL, 0x0000500804020000ULL, 0x0000201008040200ULL, 0x0000402010080400ULL,
    0x0002040810204000ULL, 0x0004081020400000ULL, 0x000a102040000000ULL, 0x0014224000000000ULL,
    0x0028440200000000ULL, 0x0050080402000000ULL, 0x0020100804020000ULL, 0x0040201008040200ULL
};

const bitboard bishop_magic[64] = {
    0x1030010228020820ULL, 0x0004102220c10080ULL, 0x4008020242037000ULL, 0x183105020000000bULL,
    0x0204046000010060ULL, 0x000c242009a04012ULL, 0x40084d1018200001ULL, 0x2002004200a42002ULL,
    0x4042450408081104ULL, 0x40001001110c2082ULL, 0x0002110821810408ULL, 0x0220044100a24102ULL,
    0x0000040308020002ULL, 0x0c01618220201214ULL, 0x0000124808980864ULL, 0x00984222020a60c1ULL,
    0x2084222008d04100ULL, 0x0128001208a10400ULL, 0x0004100204040408ULL, 0x0194001840425800ULL,
    0x1002020412021001ULL, 0x0008200410080800ULL, 0x4019000404025220ULL, 0x0240640042261000ULL,
    0x0030500a08200540ULL, 0x08141004204d0100ULL, 0x0008410850040080ULL, 0x010d080004024010ULL,
    0x0481001021014000ULL, 0x0401220005080110ULL, 0x0016040210441201ULL, 0x0004004011104200ULL,
    0x4050041010600200ULL, 0x0001045000821004ULL, 0x2400220800010804ULL, 0x0100200800010106ULL,
    0x0101080200042200ULL, 0x0806008500020050ULL, 0x00042b0440041420ULL, 0x4808430042006201ULL,
    0x0804042004401800ULL, 0x4009040221806200ULL, 0x24c00c0044002801ULL, 0x0010004204800801ULL,
    0x0000080100400400ULL, 0x0c02100232002120ULL, 0x0042300166004901ULL, 0x008c010401110120ULL,
    0x0801008a10400020ULL, 0x0140622110080400ULL, 0x0020120301210810ULL, 0x0000010142020000ULL,
    0x0540001002020800ULL, 0x0000040408020008ULL, 0x4008220828010000ULL, 0x0010040102460802ULL,
    0x0010210800942008ULL, 0x0040018405011000ULL, 0x0200402020841060ULL, 0x0280030200940400ULL,
    0x148a202160142400ULL, 0x0c06024008010100ULL, 0x4080300407080222ULL, 0x2120180208002020ULL
};

const int bishop_shifts[64] = {
    58, 59, 59, 59, 59, 59, 59, 58,
    59, 59, 59, 59, 59, 59, 59, 59,
    59, 59, 57, 57, 57, 57, 59, 59,
    59, 59, 57, 55, 55, 57, 59, 59,
    59, 59, 57, 55, 55, 57, 59, 59,
    59, 59, 57, 57, 57, 57, 59, 59,
    59, 59, 59, 59, 59, 59, 59, 59,
    58, 59, 59, 59, 59, 59, 59, 58
};

bitboard get_bishop_attacks_slow(bitboard blockers, int pos)
{
    bitboard attacks = 0ULL;

    int file = pos % 8;
    int rank = pos / 8;

    for (int i = file + 1, j = rank + 1; i < 8 && j < 8; ++i, ++j) {
        set_bit(&attacks, j * 8 + i);
        if (check_bit(blockers, j * 8 + i)) break;
    }

    for (int i = file + 1, j = rank - 1; i < 8 && j >= 0; ++i, --j) {
        set_bit(&attacks, j * 8 + i);
        if (check_bit(blockers, j * 8 + i)) break;
    }

    for (int i = file - 1, j = rank - 1; i >= 0 && j >= 0; --i, --j) {
        set_bit(&attacks, j * 8 + i);
        if (check_bit(blockers, j * 8 + i)) break;
    }

    for (int i = file - 1, j = rank + 1; i >= 0 && j < 8; --i, ++j) {
        set_bit(&attacks, j * 8 + i);
        if (check_bit(blockers, j * 8 + i)) break;
    }

    return attacks;
}

void init_bishop_attack_table(void)
{
    for (int i = 0; i < 64; ++i) {
        int n = 1 << (64 - bishop_shifts[i]);
        bishop_attack_table[i] = malloc(n * sizeof(bitboard));

        for (int j = 0; j < n; ++j) {
            bitboard blockers = get_blockers(bishop_masks[i], j);
            int index = bishop_hash(blockers, i);
            bishop_attack_table[i][index] = get_bishop_attacks_slow(blockers, i);
        }
    }
}

int bishop_hash(bitboard blockers, int pos)
{
    return apply_masks(blockers, 1, bishop_masks[pos]) * bishop_magic[pos] >> bishop_shifts[pos];
}

bitboard *rook_attack_table[64];

const bitboard rook_masks[64] = {
    0x000101010101017eULL, 0x000202020202027cULL, 0x000404040404047aULL, 0x0008080808080876ULL,
    0x001010101010106eULL, 0x002020202020205eULL, 0x004040404040403eULL, 0x008080808080807eULL,
    0x0001010101017e00ULL, 0x0002020202027c00ULL, 0x0004040404047a00ULL, 0x0008080808087600ULL,
    0x0010101010106e00ULL, 0x0020202020205e00ULL, 0x0040404040403e00ULL, 0x0080808080807e00ULL,
    0x00010101017e0100ULL, 0x00020202027c0200ULL, 0x00040404047a0400ULL, 0x0008080808760800ULL,
    0x00101010106e1000ULL, 0x00202020205e2000ULL, 0x00404040403e4000ULL, 0x00808080807e8000ULL,
    0x000101017e010100ULL, 0x000202027c020200ULL, 0x000404047a040400ULL, 0x0008080876080800ULL,
    0x001010106e101000ULL, 0x002020205e202000ULL, 0x004040403e404000ULL, 0x008080807e808000ULL,
    0x0001017e01010100ULL, 0x0002027c02020200ULL, 0x0004047a04040400ULL, 0x0008087608080800ULL,
    0x0010106e10101000ULL, 0x0020205e20202000ULL, 0x0040403e40404000ULL, 0x0080807e80808000ULL,
    0x00017e0101010100ULL, 0x00027c0202020200ULL, 0x00047a0404040400ULL, 0x0008760808080800ULL,
    0x00106e1010101000ULL, 0x00205e2020202000ULL, 0x00403e4040404000ULL, 0x00807e8080808000ULL,
    0x007e010101010100ULL, 0x007c020202020200ULL, 0x007a040404040400ULL, 0x0076080808080800ULL,
    0x006e101010101000ULL, 0x005e202020202000ULL, 0x003e404040404000ULL, 0x007e808080808000ULL,
    0x7e01010101010100ULL, 0x7c02020202020200ULL, 0x7a04040404040400ULL, 0x7608080808080800ULL,
    0x6e10101010101000ULL, 0x5e20202020202000ULL, 0x3e40404040404000ULL, 0x7e80808080808000ULL
};

const bitboard rook_magic[64] = {
    0x07001080010260c0ULL, 0x224000c820001000ULL, 0x0100085020004101ULL, 0x0100100100082004ULL,
    0x12001020085a0004ULL, 0x0300080400120300ULL, 0x0400008108220c10ULL, 0x05000a2141000082ULL,
    0x0001002040800901ULL, 0x0002002049020080ULL, 0x0041004213002000ULL, 0x40a2000812402200ULL,
    0x0042002200040810ULL, 0x4082000201300408ULL, 0x0182003200081401ULL, 0x0501000100084082ULL,
    0x0080608008400480ULL, 0x18c0008048600084ULL, 0x0006110040a00104ULL, 0x0801010020081000ULL,
    0x0420110004280100ULL, 0x0242008002800c00ULL, 0x0000140002011048ULL, 0x0001020000840041ULL,
    0x2001008200220044ULL, 0x0028400100210880ULL, 0x0800104300200100ULL, 0x0040210500181000ULL,
    0x0042001200044820ULL, 0x4802000200500c28ULL, 0x2010020400050810ULL, 0x04010082002101c4ULL,
    0x21c0104122800180ULL, 0x2200201000404000ULL, 0x2620021103002140ULL, 0x0010100421000901ULL,
    0x2000041101000800ULL, 0x000200840e000810ULL, 0x0012000102000804ULL, 0x0010024402000081ULL,
    0x61220080430a0020ULL, 0x6008402010004000ULL, 0x0008200104410010ULL, 0x010020c2000a0011ULL,
    0x0152004814120020ULL, 0x2402003008520034ULL, 0x0202000811420004ULL, 0x0210088400420001ULL,
    0x0001208000410100ULL, 0x01010c8220400100ULL, 0x0000208042001200ULL, 0x00441d0030002100ULL,
    0x0100150150480100ULL, 0x0013008204004900ULL, 0x1810300801020400ULL, 0x401c008444010200ULL,
    0x4000208009001041ULL, 0x0040008040112101ULL, 0x2020100920010141ULL, 0x111020481001005dULL,
    0x0302000804102102ULL, 0x1809008400024807ULL, 0x02010004048a0005ULL, 0x110020a102804402ULL
};

const int rook_shifts[64] = {
    52, 53, 53, 53, 53, 53, 53, 52,
    53, 54, 54, 54, 54, 54, 54, 53,
    53, 54, 54, 54, 54, 54, 54, 53,
    53, 54, 54, 54, 54, 54, 54, 53,
    53, 54, 54, 54, 54, 54, 54, 53,
    53, 54, 54, 54, 54, 54, 54, 53,
    53, 54, 54, 54, 54, 54, 54, 53,
    52, 53, 53, 53, 53, 53, 53, 52
};

bitboard get_rook_attacks_slow(bitboard blockers, int pos)
{
    bitboard attacks = 0ULL;

    int file = pos % 8;
    int rank = pos / 8;

    for (int i = file + 1; i < 8; ++i) {
        set_bit(&attacks, rank * 8 + i);
        if (check_bit(blockers, rank * 8 + i)) break;
    }

    for (int i = file - 1; i >= 0; --i) {
        set_bit(&attacks, rank * 8 + i);
        if (check_bit(blockers, rank * 8 + i)) break;
    }

    for (int i = rank + 1; i < 8; ++i) {
        set_bit(&attacks, i * 8 + file);
        if (check_bit(blockers, i * 8 + file)) break;
    }

    for (int i = rank - 1; i >= 0; --i) {
        set_bit(&attacks, i * 8 + file);
        if (check_bit(blockers, i * 8 + file)) break;
    }

    return attacks;
}

void init_rook_attack_table(void)
{
    for (int i = 0; i < 64; ++i) {
        int n = 1 << (64 - rook_shifts[i]);
        rook_attack_table[i] = malloc(n * sizeof(bitboard));

        for (int j = 0; j < n; ++j) {
            bitboard blockers = get_blockers(rook_masks[i], j);
            int index = rook_hash(blockers, i);
            rook_attack_table[i][index] = get_rook_attacks_slow(blockers, i);
        }
    }
}


int rook_hash(bitboard blockers, int pos)
{
    return apply_masks(blockers, 1, rook_masks[pos]) * rook_magic[pos] >> rook_shifts[pos];
}
